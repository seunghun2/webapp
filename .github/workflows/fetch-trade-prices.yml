name: Fetch Trade Prices

on:
  # 수동 실행
  workflow_dispatch:
  
  # 매주 월요일 오전 9시 (KST 기준) 자동 실행
  # schedule:
  #   - cron: '0 0 * * 1'  # UTC 0시 = KST 9시

jobs:
  fetch-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install axios
      
      - name: Fetch trade prices from MOLIT API
        env:
          MOLIT_API_KEY: ${{ secrets.MOLIT_API_KEY }}
        run: |
          node scripts/fetch-trade-prices-github.js
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Upload to Cloudflare D1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -f /tmp/insert_trades.sql ]; then
            wrangler d1 execute webapp-production --remote --file=/tmp/insert_trades.sql
            echo "✅ Data uploaded to Cloudflare D1"
          else
            echo "⚠️ No data to upload"
          fi
